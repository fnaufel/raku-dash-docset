<!doctype html>
<html lang="en">
<head>
    <title>Native calling interface</title>
    <meta charset="UTF-8"/>
    <meta name=viewport content="width=device-width, initial-scale=1">
    <link rel="icon" href="../favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="../css/app.css" media="screen" title="default" />
    <noscript> <style> #search { visibility: hidden; } </style> </noscript>
</head>

<body class="pod">

    <div id="___top"></div>

    <div id="header" class="pretty-box green">

        <a href="../index.html">
            <img src="../images/Camelia.svg" alt="»ö«" id="logo" width="62" height="48"/> &nbsp;Raku Documentation
        </a>

        <div id="search" class="ui-widget">
            <div class="green">
                <input placeholder="Loading..." id="query" accesskey="f" title="Enter term to search for (hit Esc to focus)"/>
            </div>
            <p id="not-found-message">
                Not in Index (<a href="nativecall.html" id="try-web-search">try site search</a>)
            </p>
        </div>

        <div class="menu">

            <div class="menu-items dark-green">
                <a class='menu-item darker-green' href='https://raku.org'><strong>Raku homepage</strong></a>
                    <a class="menu-item selected darker-green" href="../language.html"> Language </a>
                    <a class="menu-item " href="../type.html"> Types </a>
                    <a class="menu-item " href="../routine.html"> Routines </a>
                    <a class="menu-item " href="../programs.html"> Programs </a>
                    <a class="menu-item " href="https://web.libera.chat/?channel=#raku"> Chat with us </a>
            </div>

            
            

        </div>
    </div>

    <div id="content" class="pretty-box yellow content_fragment">

        <div align="right" style="display:;">
            <button title="Edit this page"  class="pencil" onclick="location='https://github.com/Raku/doc/edit/master/doc//Language/nativecall.pod6'">
                <svg width="14px" height="16px" viewBox="0 0 14 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <defs></defs>
                    <g id="Octicons" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <g id="pencil" fill="#000000">
                            <path d="M0,12 L0,15 L3,15 L11,7 L8,4 L0,12 L0,12 Z M3,14 L1,14 L1,12 L2,12 L2,13 L3,13 L3,14 L3,14 Z M13.3,4.7 L12,6 L9,3 L10.3,1.7 C10.69,1.31 11.32,1.31 11.71,1.7 L13.3,3.29 C13.69,3.68 13.69,4.31 13.3,4.7 L13.3,4.7 Z" id="Shape"></path>
                        </g>
                    </g>
                </svg>
            </button>
        </div>

        <h1 class="title">Native calling interface</h1>
        <p class="subtitle">Call into dynamic libraries that follow the C calling convention</p>

        <nav class="indexgroup">
<table id="TOC">
<caption><h2 id="TOC_Title">Table of Contents</h2></caption>
<tr class="toc-level-1"><td class="toc-number">1</td><td class="toc-text"><a href="nativecall.html#Getting_started">Getting started</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">1.1</td><td class="toc-text"><a href="nativecall.html#NativeCall_helper_module">NativeCall helper module</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">2</td><td class="toc-text"><a href="nativecall.html#Changing_names">Changing names</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">3</td><td class="toc-text"><a href="nativecall.html#Passing_and_returning_values">Passing and returning values</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">4</td><td class="toc-text"><a href="nativecall.html#Specifying_the_native_representation">Specifying the native representation</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">5</td><td class="toc-text"><a href="nativecall.html#Basic_use_of_pointers">Basic use of pointers</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">6</td><td class="toc-text"><a href="nativecall.html#Function_pointers">Function pointers</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">7</td><td class="toc-text"><a href="nativecall.html#Arrays">Arrays</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">7.1</td><td class="toc-text"><a href="nativecall.html#CArray_methods">CArray methods</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">7.2</td><td class="toc-text"><a href="nativecall.html#CArray_sub-arrays">CArray sub-arrays</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">8</td><td class="toc-text"><a href="nativecall.html#Structs">Structs</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">8.1</td><td class="toc-text"><a href="nativecall.html#CUnions"><code class="pod-code-inline">CUnion</code>s</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">8.2</td><td class="toc-text"><a href="nativecall.html#Embedding_CStructs_and_CUnions_with_HAS">Embedding CStructs and CUnions with <code class="pod-code-inline">HAS</code></a></td></tr>
<tr class="toc-level-2"><td class="toc-number">8.3</td><td class="toc-text"><a href="nativecall.html#Notes_on_memory_management">Notes on memory management</a></td></tr>
<tr class="toc-level-3"><td class="toc-number">8.3.1</td><td class="toc-text"><a href="nativecall.html#In_your_Raku_code...">In your Raku code...</a></td></tr>
<tr class="toc-level-3"><td class="toc-number">8.3.2</td><td class="toc-text"><a href="nativecall.html#In_your_C_code...">In your C code...</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">9</td><td class="toc-text"><a href="nativecall.html#Typed_pointers">Typed pointers</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">10</td><td class="toc-text"><a href="nativecall.html#Strings">Strings</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">10.1</td><td class="toc-text"><a href="nativecall.html#Explicit_memory_management">Explicit memory management</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">10.2</td><td class="toc-text"><a href="nativecall.html#Buffers_and_blobs">Buffers and blobs</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">11</td><td class="toc-text"><a href="nativecall.html#Function_arguments">Function arguments</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">12</td><td class="toc-text"><a href="nativecall.html#Library_paths_and_names">Library paths and names</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">12.1</td><td class="toc-text"><a href="nativecall.html#ABI/API_version">ABI/API version</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">12.2</td><td class="toc-text"><a href="nativecall.html#Routine">Routine</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">12.3</td><td class="toc-text"><a href="nativecall.html#Calling_into_the_standard_library">Calling into the standard library</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">13</td><td class="toc-text"><a href="nativecall.html#Exported_variables">Exported variables</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">14</td><td class="toc-text"><a href="nativecall.html#C++_support">C++ support</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">15</td><td class="toc-text"><a href="nativecall.html#Helper_functions">Helper functions</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">15.1</td><td class="toc-text"><a href="nativecall.html#sub_nativecast">sub nativecast</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">15.2</td><td class="toc-text"><a href="nativecall.html#sub_cglobal">sub cglobal</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">15.3</td><td class="toc-text"><a href="nativecall.html#sub_nativesizeof">sub nativesizeof</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">15.4</td><td class="toc-text"><a href="nativecall.html#sub_explicitly-manage">sub explicitly-manage</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">16</td><td class="toc-text"><a href="nativecall.html#Examples">Examples</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">16.1</td><td class="toc-text"><a href="nativecall.html#PostgreSQL">PostgreSQL</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">16.2</td><td class="toc-text"><a href="nativecall.html#MySQL">MySQL</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">16.3</td><td class="toc-text"><a href="nativecall.html#Microsoft_Windows">Microsoft Windows</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">16.4</td><td class="toc-text"><a href="nativecall.html#Short_tutorial_on_calling_a_C_function">Short tutorial on calling a C function</a></td></tr>
<tr class="toc-level-1"><td class="toc-number">17</td><td class="toc-text"><a href="nativecall.html#Platform_Specific_Notes">Platform Specific Notes</a></td></tr>
<tr class="toc-level-2"><td class="toc-number">17.1</td><td class="toc-text"><a href="nativecall.html#MacOS_-_DYLD_LIBRARY_PATH_is_ignored">MacOS - DYLD_LIBRARY_PATH is ignored</a></td></tr>

</table>
</nav>

        <div class="pod-body ">
            <h1 id="Getting_started"><a class="u" href="nativecall.html#___top" title="go to top of document">Getting started</a></h1>
<p><a name="index-entry-nativecall"></a> <a name="index-entry-is_native"></a> <a name="index-entry-native_(trait)"></a></p>
<p>The simplest imaginable use of <code>NativeCall</code> would look something like this:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>some_argless_function</span></span><span>()&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>something</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>some_argless_function</span></span><span>();</span></span></div></pre><p>The first line imports various traits and types. The next line looks like a relatively ordinary Raku sub declaration—with a twist. We use the <code>native</code> trait in order to specify that the sub is actually defined in a native library. The platform-specific extension (e.g., <code>.so</code> or <code>.dll</code>), as well as any customary prefixes (e.g., <code>lib</code>) will be added for you.</p>
<p>The first time you call &quot;some_argless_function&quot;, the &quot;libsomething&quot; will be loaded and the &quot;some_argless_function&quot; will be located in it. A call will then be made. Subsequent calls will be faster, since the symbol handle is retained.</p>
<p>Of course, most functions take arguments or return values—but everything else that you can do is just adding to this simple pattern of declaring a Raku sub, naming it after the symbol you want to call and marking it with the <code>native</code> trait.</p>
<p>You will also need to declare and use native types, which cannot be imported from the shared library in the same way. Please check <a href="nativetypes.html">the native types page</a> for more information.</p>
<p>Except in the case you are using your own compiled libraries, or any other kind of bundled library, shared libraries are versioned, i.e., they will be in a file <code>libfoo.so.x.y.z</code>, and this shared library will be symlinked to <code>libfoo.so.x</code>. By default, Raku will pick up that file if it&#39;s the only existing one. This is why it&#39;s safer, and advisable, to always include a version, this way:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>some_argless_function</span></span><span>()&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>,&nbsp;</span><span class="routine name raku"><span>v1</span></span><span class="keyword operator generic raku"><span>.</span></span><span>2</span><span class="keyword operator generic raku"><span>.</span></span><span>3)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>Please check the <a href="https://rakudocs.github.io/language/nativecall#ABI/API_version">section on the ABI/API version</a> for more information.</p>
<h2 id="NativeCall_helper_module"><a class="u" href="nativecall.html#___top" title="go to top of document">NativeCall helper module</a></h2>
<p>A non-core Raku module, <strong>App::GPTrixie</strong>, has a Raku program, <code>gptrixie</code>, to establish a starting code framework when initiating a new NativeCall project. It describes itself as <em>A tool to generate NativeCall code from C headers</em> and its Github repository is <a href="https://github.com/Skarsnik/gptrixie">here</a>. For now it is only for the <em>C</em> language but <em>C++</em> support is planned.</p>
<h1 id="Changing_names"><a class="u" href="nativecall.html#___top" title="go to top of document">Changing names</a></h1>
<p>Sometimes you want the name of your Raku subroutine to be different from the name used in the library you&#39;re loading. Maybe the name is long or has different casing or is otherwise cumbersome within the context of the module you are trying to create.</p>
<p>NativeCall provides a <code>symbol</code> trait for you to specify the name of the native routine in your library that may be different from your Raku subroutine name.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="routine name raku"><span>unit</span></span><span>&nbsp;</span><span class="meta class raku"><span class="storage type class raku"><span>module</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>Foo</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>our</span></span><span>&nbsp;</span><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>init</span></span><span>()&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>symbol</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>FOO_INIT</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>Inside of <code>libfoo</code> there is a routine called <code>FOO_INIT</code> but, since we&#39;re creating a module called <code>Foo</code> and we&#39;d rather call the routine as <code>Foo::init</code> (instead of <code>Foo::FOO_INIT</code>), we use the <code>symbol</code> trait to specify the name of the symbol in <code>libfoo</code> and call the subroutine whatever we want (<code>init</code> in this case).</p>
<h1 id="Passing_and_returning_values"><a class="u" href="nativecall.html#___top" title="go to top of document">Passing and returning values</a></h1>
<p>Normal Raku signatures and the <code>returns</code> trait are used in order to convey the type of arguments a native function expects and what it returns. Here is an example.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>add</span></span><span>(</span><span class="support type raku"><span>int32</span></span><span>,&nbsp;</span><span class="support type raku"><span>int32</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>calculator</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>Here, we have declared that the function takes two 32-bit integers and returns a 32-bit integer. You can find the other types that you may pass in the <a href="nativetypes.html">native types</a> page. Note that the lack of a <code>returns</code> trait is used to indicate <code>void</code> return type. Do <em>not</em> use the <code>void</code> type anywhere except in the <code>Pointer</code> parameterization.</p>
<p>For strings, there is an additional <code>encoded</code> trait to give some extra hints on how to do the marshaling.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>message_box</span></span><span>(</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>encoded</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>utf8</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>))&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>gui</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>To specify how to marshal string return types, just apply this trait to the routine itself.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>input_box</span></span><span>()&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>encoded</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>utf8</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>gui</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>Note that a <code>NULL</code> string pointer can be passed by using the <code>Str</code> type object; a <code>NULL</code> return will also be represented by the type object.</p>
<p>If the C function requires the lifetime of data, say some buffer of type <code>CArray[uint8]</code>, passed by pointer to exceed the function call, you have to ensure that the backing <code>CArray[uint8]</code> Raku object is not destroyed before the C function expects it.</p>
<p>This is particularly important for strings, as the (usually preferable) <code>is encoded</code>-way of passing strings creates only a temporary object that is automatically destroyed after the call. In this case, the argument must be manually encoded:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;void&nbsp;set_foo(const&nbsp;char&nbsp;*)</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Records&nbsp;a&nbsp;char&nbsp;pointer&nbsp;for&nbsp;later&nbsp;usage</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>set_foo</span></span><span>(</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>uint8</span></span><span>])&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;void&nbsp;use_foo(void)</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Uses&nbsp;the&nbsp;pointer&nbsp;stored&nbsp;by&nbsp;set_foo()</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>use_foo</span></span><span>()&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>string</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>FOO</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Manually&nbsp;marshal&nbsp;the&nbsp;$string&nbsp;into&nbsp;$array.&nbsp;Take&nbsp;care&nbsp;that&nbsp;$array</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;is&nbsp;not&nbsp;destroyed&nbsp;(e.g.&nbsp;by&nbsp;going&nbsp;out&nbsp;of&nbsp;scope)&nbsp;while&nbsp;the&nbsp;library</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;still&nbsp;holds&nbsp;on&nbsp;to&nbsp;it,&nbsp;after&nbsp;set_foo().</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;$string.encode&nbsp;takes&nbsp;care&nbsp;of&nbsp;UTF-8&nbsp;encoding.&nbsp;If&nbsp;$array&nbsp;is&nbsp;used</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;as&nbsp;a&nbsp;string&nbsp;by&nbsp;the&nbsp;native&nbsp;function,&nbsp;don&#39;t&nbsp;forget&nbsp;to&nbsp;append&nbsp;the</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;NUL&nbsp;byte&nbsp;that&nbsp;terminates&nbsp;a&nbsp;C&nbsp;string:&nbsp;------------v</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>array</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>uint8</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>string</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>encode</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>list</span></span><span>,&nbsp;</span><span class="constant numeric raku"><span>0</span></span><span>);</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>set_foo</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>array</span></span></span><span>);</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;...</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>use_foo</span></span><span>();</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;It&#39;s&nbsp;fine&nbsp;if&nbsp;$array&nbsp;goes&nbsp;out&nbsp;of&nbsp;scope&nbsp;starting&nbsp;from&nbsp;here.</span></span></span></div></pre><p><a name="index-entry-repr"></a><a name="index-entry-is_repr"></a><a name="index-entry-CStruct_(native_representation)"></a></p>
<h1 id="Specifying_the_native_representation"><a class="u" href="nativecall.html#___top" title="go to top of document">Specifying the native representation</a></h1>
<p>When working with native functions, sometimes you need to specify what kind of native data structure is going to be used. <code>is repr</code> is the term employed for that.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>timespec</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>tv_sec</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>long</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>tv_nanosecs</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>clock_gettime</span></span><span>(</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>clock-id</span></span></span><span>,&nbsp;</span><span class="routine name raku"><span>timespec</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>tspec</span></span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>--&gt;</span></span><span>&nbsp;</span><span class="support type raku"><span>uint32</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="routine name raku"><span>timespec</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>this-time</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>.=</span></span><span class="support function raku"><span>new</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>result</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>clock_gettime</span></span><span>(&nbsp;</span><span class="constant numeric raku"><span>0</span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>this-time</span></span></span><span>);</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>result</span></span><span>,&nbsp;</span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>this-time</span></span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;OUTPUT:&nbsp;«0,&nbsp;timespec&lt;65385480&gt;␤»</span><span>&nbsp;</span></span></span></div></pre><p>The original function we are calling, <a href="https://linux.die.net/man/3/clock_gettime">clock_gettime</a>, uses a pointer to the <code>timespec</code> struct as second argument. We declare it as a <a href="../syntax/class.html">class</a> here, but specify its representation as <code>is repr(&#39;CStruct&#39;)</code>, to indicate it corresponds to a C data structure. When we create an object of that class, we are creating exactly the kind of pointer <code>clock_gettime</code> expects. This way, data can be transferred seamlessly to and from the native interface.</p>
<p><a name="index-entry-Pointer"></a></p>
<h1 id="Basic_use_of_pointers"><a class="u" href="nativecall.html#___top" title="go to top of document">Basic use of pointers</a></h1>
<p>When the signature of your native function needs a pointer to some native type (<code>int32</code>, <code>uint32</code>, etc.) all you need to do is declare the argument <code>is rw</code>:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;C&nbsp;prototype&nbsp;is&nbsp;void&nbsp;my_version(int&nbsp;*major,&nbsp;int&nbsp;*minor)</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>my_version</span></span><span>(</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>,&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>my_version</span></span><span>(</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>major</span></span></span><span>,&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>minor</span></span></span><span>);&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Pass&nbsp;a&nbsp;pointer&nbsp;to</span></span></span></div></pre><p>When you just want to use/pass a pointer using the <code>Pointer</code> class you have to create the pointers when declaring them; then you can do this without specifying what type it points to. Here is an example:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;C&nbsp;prototype&nbsp;is&nbsp;void&nbsp;create_object(void&nbsp;**object)</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>create_object</span></span><span>(</span><span class="support type raku"><span>Pointer</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>p</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>();</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>create_object</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>p</span></span></span><span>);&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;pointer&nbsp;is&nbsp;set&nbsp;by&nbsp;create_object</span></span></span></div></pre><p>The <code>Pointer</code> class can be used with types as well e.g. <code>Pointer[Str]</code>. Note that Str is a pointer to a string (<code>char *</code> in C/C++). So in that case, you can use <code>Pointer[Str]</code> or <code>Str</code>.</p>
<p>Sometimes you need to get a pointer (for example, a filehandle) back from a C library. You don&#39;t care about what it points to - you just need to grab hold of it. The <code>Pointer</code> type provides for this.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>Foo_init</span></span><span>()&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>Foo_free</span></span><span>(</span><span class="support type raku"><span>Pointer</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>This works out OK, but you may fancy working with a type named something better than <code>Pointer</code>. It turns out that any class with the representation <code>CPointer</code> can serve this role. This means you can expose libraries that work on handles by writing a class like this:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>FooHandle</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CPointer</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation whitespace comment leading raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Here&nbsp;are&nbsp;the&nbsp;actual&nbsp;NativeCall&nbsp;functions.</span><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>Foo_init</span></span><span>()&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="routine name raku"><span>FooHandle</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>Foo_free</span></span><span>(</span><span class="routine name raku"><span>FooHandle</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>Foo_query</span></span><span>(</span><span class="routine name raku"><span>FooHandle</span></span><span>,&nbsp;</span><span class="support type raku"><span>Str</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>int8</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>Foo_close</span></span><span>(</span><span class="routine name raku"><span>FooHandle</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>int8</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation whitespace comment leading raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Here&nbsp;are&nbsp;the&nbsp;methods&nbsp;we&nbsp;use&nbsp;to&nbsp;expose&nbsp;it&nbsp;to&nbsp;the&nbsp;outside&nbsp;world.</span><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>new</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>Foo_init</span></span><span>();</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>query</span></span><span>(</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>stmt</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>Foo_query</span></span><span>(</span><span class="variable language raku"><span>self</span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>stmt</span></span></span><span>);</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>close</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>Foo_close</span></span><span>(</span><span class="variable language raku"><span>self</span></span><span>);</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation whitespace comment leading raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Free&nbsp;data&nbsp;when&nbsp;the&nbsp;object&nbsp;is&nbsp;garbage&nbsp;collected.</span><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>submethod</span></span><span>&nbsp;</span><span class="entity name function raku"><span>DESTROY</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>Foo_free</span></span><span>(</span><span class="variable language raku"><span>self</span></span><span>);</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>Note that the <code>CPointer</code> representation can do nothing more than hold a C pointer. This means that your class cannot have extra attributes. However, for simple libraries this may be a neat way to expose an object oriented interface to it.</p>
<p>Of course, you can always have an empty class:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>DoorHandle</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CPointer</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>And just use the class as you would use <code>Pointer</code>, but with potential for better type safety and more readable code.</p>
<p>Once again, type objects are used to represent <code>NULL</code> pointers.</p>
<h1 id="Function_pointers"><a class="u" href="nativecall.html#___top" title="go to top of document">Function pointers</a></h1>
<p>C libraries can expose pointers to C functions as return values of functions and as members of structures such as structs and unions.</p>
<p>Example of invoking a function pointer <code>$fptr</code> returned by a function <code>f</code>, using a signature defining the desired function parameters and return value:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>f</span></span><span>()&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>mylib</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>fptr</span></span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>f</span></span><span>();</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>&amp;</span></span><span class="variable other identifier raku"><span>newfunc</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>nativecast</span></span><span>(</span><span class="keyword operator generic raku"><span>:</span></span><span>(</span><span class="support type raku"><span>Str</span></span><span>,&nbsp;</span><span class="support type raku"><span>size_t</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>--&gt;</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>),&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>fptr</span></span></span><span>);</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>newfunc</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>test</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>,&nbsp;</span><span class="constant numeric raku"><span>4</span></span><span>);</span></span></div></pre><h1 id="Arrays"><a class="u" href="nativecall.html#___top" title="go to top of document">Arrays</a></h1>
<p>NativeCall has some support for arrays. It is constrained to work with machine-size integers, doubles and strings, sized numeric types, arrays of pointers, arrays of structs, and arrays of arrays.</p>
<p>Raku arrays, which support amongst other things laziness, are laid out in memory in a radically different way to C arrays. Therefore, the NativeCall library offers a much more primitive CArray type, which you must use if working with C arrays.</p>
<p>Here is an example of passing a C array.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>RenderBarChart</span></span><span>(</span><span class="support type raku"><span>Str</span></span><span>,&nbsp;</span><span class="support type raku"><span>int32</span></span><span>,&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>Str</span></span><span>],&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>num64</span></span><span>])&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>chart</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>titles</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>:=</span></span><span>&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>Str</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>titles</span></span></span><span>[</span><span class="constant numeric raku"><span>0</span></span><span>]&nbsp;&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>Me</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>titles</span></span></span><span>[</span><span class="constant numeric raku"><span>1</span></span><span>]&nbsp;&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>You</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>titles</span></span></span><span>[</span><span class="constant numeric raku"><span>2</span></span><span>]&nbsp;&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>Hagrid</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>values</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>:=</span></span><span>&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>num64</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>values</span></span></span><span>[</span><span class="constant numeric raku"><span>0</span></span><span>]&nbsp;&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>59.5e0</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>values</span></span></span><span>[</span><span class="constant numeric raku"><span>1</span></span><span>]&nbsp;&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>61.2e0</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>values</span></span></span><span>[</span><span class="constant numeric raku"><span>2</span></span><span>]&nbsp;&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>180.7e0</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>RenderBarChart</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>Weights&nbsp;(kg)</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>,&nbsp;</span><span class="constant numeric raku"><span>3</span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>titles</span></span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>@</span></span><span class="variable other identifier raku"><span>values</span></span></span><span>);</span></span></div></pre><p>Note that binding was used to <code>@titles</code>, <em>not</em> assignment! If you assign, you are putting the values into a Raku array, and it will not work out. If this all freaks you out, forget you ever knew anything about the <code>@</code> sigil and just use <code>$</code> all the way when using NativeCall.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>titles</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>Str</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>titles</span></span></span><span>[</span><span class="constant numeric raku"><span>0</span></span><span>]&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>Me</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>titles</span></span></span><span>[</span><span class="constant numeric raku"><span>1</span></span><span>]&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>You</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>titles</span></span></span><span>[</span><span class="constant numeric raku"><span>2</span></span><span>]&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>Hagrid</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></div></pre><p>Getting return values for arrays works out just the same.</p>
<p>Some library APIs may take an array as a buffer that will be populated by the C function and, for instance, return the actual number of items populated:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>get_n_ints</span></span><span>(</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>int32</span></span><span>],&nbsp;</span><span class="support type raku"><span>int32</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>ints</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>In these cases it is important that the CArray has at least the number of elements that are going to be populated before passing it to the native subroutine, otherwise the C function may stomp all over Raku&#39;s memory leading to possibly unpredictable behavior:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>number_of_ints</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>10</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>ints</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>int32</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>allocate</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>number_of_ints</span></span></span><span>);&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;instantiates&nbsp;an&nbsp;array&nbsp;with&nbsp;10&nbsp;elements</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>n</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>get_n_ints</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>ints</span></span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>number_of_ints</span></span></span><span>);</span></span></div></pre><p><em>Note</em>: <code>allocate</code> was introduced in Rakudo 2018.05. Before that, you had to use this mechanism to extend an array to a number of elements:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>ints</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>int32</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>number_of_ints</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>10</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>ints</span></span></span><span>[</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>number_of_ints</span></span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>-</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span><span>]&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>0</span></span><span>;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;extend&nbsp;the&nbsp;array&nbsp;to&nbsp;10&nbsp;items</span><span>&nbsp;</span></span></span></div></pre><p>It is important that you understand how arrays manage memory. When you create an array yourself, then you can add elements to it as you wish and it will be expanded for you as required. However, this may result in it being moved in memory (assignments to existing elements will never cause this, however). This means you&#39;d best know what you&#39;re doing if you twiddle with an array after passing it to a C library.</p>
<p>By contrast, when a C library returns an array to you, then the memory can not be managed by <code>NativeCall</code>, and it doesn&#39;t know where the array ends. Presumably, something in the library API tells you this (for example, you know that when you see a null element, you should read no further). Note that <code>NativeCall</code> can offer you no protection whatsoever here - do the wrong thing, and you will get a segfault or cause memory corruption. This isn&#39;t a shortcoming of <code>NativeCall</code>, it&#39;s the way the big bad native world works. Scared? Here, have a hug. Good luck!</p>
<p><a name="index-entry-CArray"></a> <a name="index-entry-CArray_methods"></a></p>
<h2 id="CArray_methods"><a class="u" href="nativecall.html#___top" title="go to top of document">CArray methods</a></h2>
<p>Besides the usual methods available on every Raku instance, <code>CArray</code> provides the following methods that can be used to interact with it from the Raku point of view:</p>
<ul><li><p><code>elems</code> provides the number of elements within the array;</p>
</li>
<li><p><code>AT-POS</code> provides a specific element at the given position (starting from zero). This method is not intended to be used directly, but invoked using the subscript notation <code>[]</code>.</p>
</li>
<li><p><code>list</code> provides the <a href="../type/List.html">List</a> of elements within the array building it from the native array iterator.</p>
</li>
</ul>
<p>As an example, consider the following simple piece of code:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>native-array</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>int32</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>(&nbsp;</span><span class="constant numeric raku"><span>1</span></span><span>,&nbsp;</span><span class="constant numeric raku"><span>2</span></span><span>,&nbsp;</span><span class="constant numeric raku"><span>3</span></span><span>,&nbsp;</span><span class="constant numeric raku"><span>4</span></span><span>,&nbsp;</span><span class="constant numeric raku"><span>5</span></span><span>&nbsp;);</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>Number&nbsp;of&nbsp;elements:&nbsp;</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>~</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>native-array</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>elems</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;walk&nbsp;the&nbsp;array</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="keyword control repeat raku"><span>for</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>native-array</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>list</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>-&gt;</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>elem</span></span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>Current&nbsp;element&nbsp;is:&nbsp;</span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>elem</span></span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;get&nbsp;every&nbsp;element&nbsp;by&nbsp;its&nbsp;index-based&nbsp;position</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="keyword control repeat raku"><span>for</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>0</span></span><span class="keyword operator multi-symbol raku"><span>..</span></span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>native-array</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>elems</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>-</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>-&gt;</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>position</span></span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>Element&nbsp;at&nbsp;position&nbsp;</span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>position</span></span><span>&nbsp;is&nbsp;</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator generic raku"><span>~</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>native-array</span></span></span><span>[&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>position</span></span></span><span>&nbsp;];</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div></pre><p>that produces the following output</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="routine name raku"><span>Number</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>of</span></span><span>&nbsp;</span><span class="routine name raku"><span>elements</span></span><span class="keyword operator generic raku"><span>:</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>5</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Current</span></span><span>&nbsp;</span><span class="routine name raku"><span>element</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span class="keyword operator generic raku"><span>:</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Current</span></span><span>&nbsp;</span><span class="routine name raku"><span>element</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span class="keyword operator generic raku"><span>:</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>2</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Current</span></span><span>&nbsp;</span><span class="routine name raku"><span>element</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span class="keyword operator generic raku"><span>:</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>3</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Current</span></span><span>&nbsp;</span><span class="routine name raku"><span>element</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span class="keyword operator generic raku"><span>:</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>4</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Current</span></span><span>&nbsp;</span><span class="routine name raku"><span>element</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span class="keyword operator generic raku"><span>:</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>5</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Element</span></span><span>&nbsp;</span><span class="routine name raku"><span>at</span></span><span>&nbsp;</span><span class="routine name raku"><span>position</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>0</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Element</span></span><span>&nbsp;</span><span class="routine name raku"><span>at</span></span><span>&nbsp;</span><span class="routine name raku"><span>position</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>2</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Element</span></span><span>&nbsp;</span><span class="routine name raku"><span>at</span></span><span>&nbsp;</span><span class="routine name raku"><span>position</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>2</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>3</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Element</span></span><span>&nbsp;</span><span class="routine name raku"><span>at</span></span><span>&nbsp;</span><span class="routine name raku"><span>position</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>3</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>4</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Element</span></span><span>&nbsp;</span><span class="routine name raku"><span>at</span></span><span>&nbsp;</span><span class="routine name raku"><span>position</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>4</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>5</span></span></span></div></pre><h2 id="CArray_sub-arrays"><a class="u" href="nativecall.html#___top" title="go to top of document">CArray sub-arrays</a></h2>
<p>To use a sub-array of a given CArray is a simple exercise of pointer math. Feel free to use the following example to create your own:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>subarray</span></span><span>&nbsp;(</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>a</span></span></span><span>,&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>=&nbsp;The&nbsp;CArray&nbsp;to&nbsp;use</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>o</span></span></span><span>&nbsp;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>=&nbsp;The&nbsp;offset&nbsp;into&nbsp;the&nbsp;array&nbsp;where&nbsp;the&nbsp;subarray&nbsp;should&nbsp;start</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>export</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>b</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>nativecast</span></span><span>(</span><span class="support type raku"><span>Pointer</span></span><span>[</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>a</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="storage modifier type constraints raku"><span>of</span></span><span>],&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>a</span></span></span><span>);</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="routine name raku"><span>nativecast</span></span><span>(</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>a</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="storage modifier type constraints raku"><span>of</span></span><span>],&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>b</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>add</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>o</span></span></span><span>)&nbsp;);</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><h1 id="Structs"><a class="u" href="nativecall.html#___top" title="go to top of document">Structs</a></h1>
<p>Thanks to representation polymorphism, it&#39;s possible to declare a normal looking Raku class that, under the hood, stores its attributes in the same way a C compiler would lay them out in a similar struct definition. All it takes is a quick use of the <code>repr</code> trait:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>Point</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>num64</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>x</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>num64</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>y</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>The attributes can only be of the types that NativeCall knows how to marshal into struct fields. Currently, structs can contain machine-sized integers, doubles, strings, and other NativeCall objects (<code>CArray</code>s, and those using the <code>CPointer</code> and <code>CStruct</code> reprs). Other than that, you can do the usual set of things you would with a class; you could even have some of the attributes come from roles or have them inherited from another class. Of course, methods are completely fine too. Go wild!</p>
<p><code>CStruct</code> objects are passed to native functions by reference and native functions must also return <code>CStruct</code> objects by reference. The memory management rules for these references are very much like the rules for arrays, though simpler since a struct is never resized. When you create a struct, the memory is managed for you and when the variable(s) pointing to the instance of a <code>CStruct</code> go away, the memory will be freed when the GC gets to it. When a <code>CStruct</code>-based type is used as the return type of a native function, the memory is not managed for you by the GC.</p>
<p>NativeCall currently doesn&#39;t put object members in containers, so assigning new values to them (with <code>=</code>) doesn&#39;t work. Instead, you have to bind (with <code>:=</code>) new values to the private members:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>MyStruct</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>num64</span></span><span>]&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>arr</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>str</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="routine name raku"><span>Point</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>point</span></span></span><span>;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Point&nbsp;is&nbsp;a&nbsp;user-defined&nbsp;class&nbsp;shown&nbsp;above</span><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>submethod</span></span><span>&nbsp;</span><span class="entity name function raku"><span>TWEAK</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>arr</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>:=</span></span><span>&nbsp;</span><span class="support type raku"><span>CArray</span></span><span>[</span><span class="support type raku"><span>num64</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>arr</span></span></span><span>[</span><span class="constant numeric raku"><span>0</span></span><span>]&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>0.9e0</span></span><span>;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>arr</span></span></span><span>[</span><span class="constant numeric raku"><span>1</span></span><span>]&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>0.2e0</span></span><span>;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>arr</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>:=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>arr</span></span></span><span>;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>str</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>:=</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>Raku&nbsp;is&nbsp;fun</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>point</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>:=</span></span><span>&nbsp;</span><span class="routine name raku"><span>Point</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>As you may have predicted by now, a <code>NULL</code> pointer is represented by the type object of the struct type.</p>
<h2 id="CUnions"><a class="u" href="nativecall.html#___top" title="go to top of document"><code>CUnion</code>s</a></h2>
<p>Likewise, it is possible to declare a Raku class that stores its attributes the same way a C compiler would lay them out in a similar <code>union</code> definition; using the <code>CUnion</code> representation:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>MyUnion</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CUnion</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>flags32</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int64</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>flags64</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>nativesizeof</span></span><span>(</span><span class="routine name raku"><span>MyUnion</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>);&nbsp;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;OUTPUT:&nbsp;«8␤»</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="punctuation whitespace comment leading raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;ie.&nbsp;max(sizeof(MyUnion.flags32),&nbsp;sizeof(MyUnion.flags64))</span><span>&nbsp;</span></span></span></div></pre><h2 id="Embedding_CStructs_and_CUnions_with_HAS"><a class="u" href="nativecall.html#___top" title="go to top of document">Embedding CStructs and CUnions with <a name="index-entry-HAS__declarator-HAS"><span class="index-entry"><code>HAS</code></span></a></a></h2>
<p><code>CStruct</code>s and <code>CUnion</code>s can be in turn referenced by—or embedded into—a surrounding <code>CStruct</code> and <code>CUnion</code>. To say the former we use <code>has</code> as usual, and to do the latter we use the <code>HAS</code> declarator instead:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>MyStruct</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="routine name raku"><span>Point</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>point</span></span></span><span>;&nbsp;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;referenced</span><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>flags</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>nativesizeof</span></span><span>(</span><span class="routine name raku"><span>MyStruct</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>);&nbsp;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;OUTPUT:&nbsp;«16␤»</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="punctuation whitespace comment leading raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;ie.&nbsp;sizeof(struct&nbsp;Point&nbsp;*)&nbsp;+&nbsp;sizeof(int32_t)</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>MyStruct2</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>HAS</span></span><span>&nbsp;</span><span class="routine name raku"><span>Point</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>point</span></span></span><span>;&nbsp;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;embedded</span><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>flags</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>nativesizeof</span></span><span>(</span><span class="routine name raku"><span>MyStruct2</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>);&nbsp;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;OUTPUT:&nbsp;«24␤»</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="punctuation whitespace comment leading raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;ie.&nbsp;sizeof(struct&nbsp;Point)&nbsp;+&nbsp;sizeof(int32_t)</span><span>&nbsp;</span></span></span></div></pre><h2 id="Notes_on_memory_management"><a class="u" href="nativecall.html#___top" title="go to top of document">Notes on memory management</a></h2>
<p>When allocating a struct for use as a struct, make sure that you allocate your own memory in your C functions. If you&#39;re passing a struct into a C function which needs a <code>Str</code>/<code>char*</code> allocated ahead of time, be sure to assign a container for a variable of type <code>Str</code> prior to passing your struct into the function.</p>
<h3 id="In_your_Raku_code..."><a class="u" href="nativecall.html#___top" title="go to top of document">In your Raku code...</a></h3>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>AStringAndAnInt</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>a_string</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>an_int32</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>init_struct</span></span><span>(</span><span class="routine name raku"><span>AStringAndAnInt</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>,&nbsp;</span><span class="support type raku"><span>Str</span></span><span>,&nbsp;</span><span class="support type raku"><span>int32</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>simple-struct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>submethod</span></span><span>&nbsp;</span><span class="entity name function raku"><span>BUILD</span></span><span>(</span><span class="keyword operator generic raku"><span>:</span></span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>a_string</span></span></span><span>,&nbsp;</span><span class="keyword operator generic raku"><span>:</span></span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>an_int</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>init_struct</span></span><span>(</span><span class="variable language raku"><span>self</span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>a_string</span></span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>an_int</span></span></span><span>);</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>In this code we first set up our members, <code>$.a_string</code> and <code>$.an_int32</code>. After that we declare our <code>init_struct()</code> function for the <code>init()</code> method to wrap around; this function is then called from <code>BUILD</code> to effectively assign the values before returning the created object.</p>
<p>Please note that BUILD is binding attributes of native types, such as <code>$.an_int32</code>. You can always bind native types this way.</p>
<h3 id="In_your_C_code..."><a class="u" href="nativecall.html#___top" title="go to top of document">In your C code...</a></h3>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="routine name raku"><span>typedef</span></span><span>&nbsp;</span><span class="routine name raku"><span>struct</span></span><span>&nbsp;</span><span class="routine name raku"><span>a_string_and_an_int32_t_</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="routine name raku"><span>char</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="routine name raku"><span>a_string</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="routine name raku"><span>int32_t</span></span><span>&nbsp;</span><span class="routine name raku"><span>an_int32</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span><span>&nbsp;</span><span class="routine name raku"><span>a_string_and_an_int32_t</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div></pre><p>Here&#39;s the structure. Notice how we&#39;ve got a <code>char *</code> there.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="support function raku"><span>void</span></span><span>&nbsp;</span><span class="routine name raku"><span>init_struct</span></span><span>(</span><span class="routine name raku"><span>a_string_and_an_int32_t</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="routine name raku"><span>target</span></span><span>,&nbsp;</span><span class="routine name raku"><span>char</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="support type raku"><span>str</span></span><span>,&nbsp;</span><span class="routine name raku"><span>int32_t</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="routine name raku"><span>target</span></span><span class="keyword operator multi-symbol raku"><span>-&gt;</span></span><span class="routine name raku"><span>an_int32</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="routine name raku"><span>target</span></span><span class="keyword operator multi-symbol raku"><span>-&gt;</span></span><span class="routine name raku"><span>a_string</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>strdup</span></span><span>(</span><span class="support type raku"><span>str</span></span><span>);</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;</span><span class="keyword control flowcontrol raku"><span>return</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div></pre><p>In this function we initialize the C structure by assigning an integer by value, and passing the string by reference. The function allocates memory that it points <code>char *a_string</code> to within the structure as it copies the string. (Note you will also have to manage deallocation of the memory as well to avoid memory leaks.)</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;A&nbsp;long&nbsp;time&nbsp;ago&nbsp;in&nbsp;a&nbsp;galaxy&nbsp;far,&nbsp;far&nbsp;away...</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>foo</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>AStringAndAnInt</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>(</span><span class="string pair key raku"><span>a_string&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>str</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>,&nbsp;</span><span class="string pair key raku"><span>an_int&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>123</span></span><span>);</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>foo&nbsp;is&nbsp;</span><span class="meta interpolation raku"><span class="punctuation section embedded begin raku"><span>{</span></span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>foo</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>a_string</span></span><span class="punctuation section embedded end raku"><span>}</span></span></span><span>&nbsp;and&nbsp;</span><span class="meta interpolation raku"><span class="punctuation section embedded begin raku"><span>{</span></span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>foo</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>an_int32</span></span><span class="punctuation section embedded end raku"><span>}</span></span></span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;OUTPUT:&nbsp;«foo&nbsp;is&nbsp;str&nbsp;and&nbsp;123␤»</span><span>&nbsp;</span></span></span></div></pre><h1 id="Typed_pointers"><a class="u" href="nativecall.html#___top" title="go to top of document">Typed pointers</a></h1>
<p>You can type your <code>Pointer</code> by passing the type as a parameter. It works with the native type but also with <code>CArray</code> and <code>CStruct</code> defined types. NativeCall will not implicitly allocate the memory for it even when calling <code>new</code> on them. It&#39;s mostly useful in the case of a C routine returning a pointer, or if it&#39;s a pointer embedded in a <code>CStruct</code>.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>strdup</span></span><span>(</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>s</span></span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>--&gt;</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>[</span><span class="support type raku"><span>Str</span></span><span>])&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>[</span><span class="support type raku"><span>Str</span></span><span>]&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>p</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>strdup</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>Success!</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>);</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>p</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>deref</span></span><span>;</span></span></div></pre><p>You have to call <a name="index-entry-deref-.deref"><span class="index-entry"><code>.deref</code></span></a> on <code>Pointer</code>s to access the embedded type. In the example above, declaring the type of the pointer avoids typecasting error when dereferenced. Please note that the original <a href="https://en.cppreference.com/w/c/experimental/dynamic/strdup"><code>strdup</code></a> returns a pointer to <code>char</code>; we are using <code>Pointer[Str]</code>.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>[</span><span class="support type raku"><span>int32</span></span><span>]&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>p</span></span></span><span>;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>For&nbsp;a&nbsp;pointer&nbsp;on&nbsp;int32;</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>[</span><span class="routine name raku"><span>MyCstruct</span></span><span>]&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>p2</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>some_c_routine</span></span><span>();</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="routine name raku"><span>MyCstruct</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>mc</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>p2</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>deref</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>mc</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>field1</span></span><span>;</span></span></div></pre><p>It&#39;s quite common for a native function to return a pointer to an array of elements. Typed pointers can be dereferenced as an array to obtain individual elements.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>n</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>5</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;array&nbsp;of&nbsp;length&nbsp;$n</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>[</span><span class="routine name raku"><span>Point</span></span><span>]&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>plot</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>some_other_c_routine</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>n</span></span></span><span>);</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;display&nbsp;the&nbsp;5&nbsp;elements&nbsp;in&nbsp;the&nbsp;array</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="keyword control repeat raku"><span>for</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>..</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>n</span></span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>-&gt;</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>i</span></span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>x</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>plot</span></span></span><span>[</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>i</span></span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>-</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="keyword operator word raku"><span>x</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>y</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>plot</span></span></span><span>[</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>i</span></span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>-</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span><span>]</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>y</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>i</span></span><span>:&nbsp;(</span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>x</span></span><span>,&nbsp;</span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>y</span></span><span>)</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>Pointers can also be updated to reference successive elements in the array:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>[</span><span class="routine name raku"><span>Point</span></span><span>]&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>elem</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>plot</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;show&nbsp;differences&nbsp;between&nbsp;successive&nbsp;points</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="keyword control repeat raku"><span>for</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>..</span></span><span class="keyword operator generic raku"><span>^</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>n</span></span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="routine name raku"><span>Point</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>lo</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>elem</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>deref</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator multi-symbol raku"><span>++</span></span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>elem</span></span></span><span>;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;equivalent&nbsp;to&nbsp;$elem&nbsp;=&nbsp;$elem.add(1);</span><span>&nbsp;</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="routine name raku"><span>Point</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>hi</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;(</span><span class="keyword operator multi-symbol raku"><span>++</span></span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>elem</span></span></span><span>)</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>deref</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>dx</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>hi</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="keyword operator word raku"><span>x</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>lo</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="keyword operator word raku"><span>x</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>dy</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>hi</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>y</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>lo</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>y</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>_</span></span><span>:&nbsp;delta&nbsp;(</span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>dx</span></span><span>,&nbsp;</span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>dy</span></span><span>)</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>Void pointers can also be used by declaring them <code>Pointer[void]</code>. Please consult <a href="nativetypes.html#The_void_type">the native types documentation</a> for more information on the subject.</p>
<h1 id="Strings"><a class="u" href="nativecall.html#___top" title="go to top of document">Strings</a></h1>
<h2 id="Explicit_memory_management"><a class="u" href="nativecall.html#___top" title="go to top of document">Explicit memory management</a></h2>
<p>Let&#39;s say there is some C code that caches strings passed, like so:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>include&nbsp;&lt;stdlib.h&gt;</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>static</span></span><span>&nbsp;</span><span class="routine name raku"><span>char</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="routine name raku"><span>__VERSION</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>char</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>get_version</span></span><span>()</span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control flowcontrol raku"><span>return</span></span><span>&nbsp;</span><span class="routine name raku"><span>__VERSION</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>char</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>set_version</span></span><span>(</span><span class="routine name raku"><span>char</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="routine name raku"><span>version</span></span><span>)</span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control conditional raku"><span>if</span></span><span>&nbsp;(</span><span class="routine name raku"><span>__VERSION</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>!=</span></span><span>&nbsp;</span><span class="routine name raku"><span>NULL</span></span><span>)&nbsp;</span><span class="routine name raku"><span>free</span></span><span>(</span><span class="routine name raku"><span>__VERSION</span></span><span>);</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>__VERSION</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>version</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control flowcontrol raku"><span>return</span></span><span>&nbsp;</span><span class="routine name raku"><span>__VERSION</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>If you were to write bindings for <code>get_version</code> and <code>set_version</code>, they would initially look like this, but will not work as intended:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>get_version</span></span><span>(</span><span class="keyword operator multi-symbol raku"><span>--&gt;</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>./version</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>set_version</span></span><span>(</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>--&gt;</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>./version</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>set_version</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>1.0.0</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>);&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;1.0.0</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>get_version</span></span><span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Differs&nbsp;on&nbsp;each&nbsp;run</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>set_version</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>1.0.1</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>);&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Double&nbsp;free;&nbsp;segfaults</span><span>&nbsp;</span></span></span></div></pre><p>This code segfaults on the second <code>set_version</code> call because it tries to free the string passed on the first call after the garbage collector had already done so. If the garbage collector shouldn&#39;t free a string passed to a native function, use <code>explicitly-manage</code> with it:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>set_version</span></span><span>(</span><span class="routine name raku"><span>explicitly-manage</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>1.0.0</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>));&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;1.0.0</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>get_version</span></span><span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;1.0.0</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>set_version</span></span><span>(</span><span class="routine name raku"><span>explicitly-manage</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>1.0.1</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>));&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;1.0.1</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>get_version</span></span><span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;1.0.1</span><span>&nbsp;</span></span></span></div></pre><p>Bear in mind all memory management for explicitly managed strings must be handled by the C library itself or through the NativeCall API to prevent memory leaks.</p>
<h2 id="Buffers_and_blobs"><a class="u" href="nativecall.html#___top" title="go to top of document">Buffers and blobs</a></h2>
<p><a href="../type/Blob.html">Blob</a>s and <a href="../type/Buf.html">Buf</a>s are the Raku way of storing binary data. We can use them for interchange of data with native functions and data structures, although not directly. We will have to use <a href="../routine/nativecast.html"><code>nativecast</code></a>.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>blob</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>Blob</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>(</span><span class="constant numeric radix raku"><span>0x22</span></span><span>,&nbsp;</span><span class="constant numeric radix raku"><span>0x33</span></span><span>);</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>src</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>nativecast</span></span><span>(</span><span class="support type raku"><span>Pointer</span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>blob</span></span></span><span>);</span></span></div></pre><p>This <code>$src</code> can then be used as an argument for any native function that takes a <code>Pointer</code>. The opposite, putting values pointed to by a <code>Pointer</code> into a <code>Buf</code> or using it to initialize a <code>Blob</code> is not directly supported. You might want to use <a href="https://github.com/salortiz/NativeHelpers-Blob"><code>NativeHelpers::Blob</code></a> to do this kind of operations.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>esponja</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>blob-from-pointer</span></span><span>(&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>inter</span></span></span><span>,&nbsp;</span><span class="keyword operator generic raku"><span>:</span></span><span class="constant numeric raku"><span>2</span></span><span>elems,&nbsp;</span><span class="keyword operator generic raku"><span>:</span></span><span class="routine name raku"><span>type</span></span><span>(</span><span class="support type raku"><span>Blob</span></span><span>[</span><span class="support type raku"><span>int8</span></span><span>]));</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>esponja</span></span></span><span>;</span></span></div></pre><h1 id="Function_arguments"><a class="u" href="nativecall.html#___top" title="go to top of document">Function arguments</a></h1>
<p>NativeCall also supports native functions that take functions as arguments. One example of this is using function pointers as callbacks in an event-driven system. When binding these functions via NativeCall, one needs only provide the equivalent signature as <a href="../type/Signature.html#Constraining_signatures_of_Callables">a constraint on the code parameter</a>. In the case of NativeCall, however, as of Rakudo 2019.07, a space between the function argument and the signature, and the colon of a normal <code>Signature</code> literal is omitted, as in:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;void&nbsp;SetCallback(int&nbsp;(*callback)(const&nbsp;char&nbsp;*))</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>SetCallback</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>&amp;</span></span><span class="variable other identifier raku"><span>callback</span></span></span><span>&nbsp;(</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>--&gt;</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>))&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>mylib</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>Note: the native code is responsible for memory management of values passed to Raku callbacks this way. In other words, NativeCall will not free() strings passed to callbacks.</p>
<p>It is important that any code passed as a native callback handles its exceptions and, if applicable, returns an appropriate error value to the native code that invoked it. It is not allowed to throw an exception out of a native callback, and doing so will lead to process termination.</p>
<h1 id="Library_paths_and_names"><a class="u" href="nativecall.html#___top" title="go to top of document">Library paths and names</a></h1>
<p>The <code>native</code> trait accepts the library name, the full path, or a subroutine returning either of the two. When using the library name, the name is assumed to be prepended with <code>lib</code> and appended with <code>.so</code> (or just appended with <code>.dll</code> on Windows), and will be searched for in the paths in the <code>LD_LIBRARY_PATH</code> (<code>PATH</code> on Windows) environment variable.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>constant</span></span><span>&nbsp;</span><span class="routine name raku"><span>LIBMYSQL</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>mysqlclient</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>constant</span></span><span>&nbsp;</span><span class="routine name raku"><span>LIBFOO</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>/usr/lib/libfoo.so.1</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>LIBBAR</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>path</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta shell quote single raku"><span class="string quoted q shell operator raku"><span>qx</span></span><span class="punctuation section embedded shell begin raku"><span>/</span></span><span>pkg-config&nbsp;--libs&nbsp;libbar</span><span class="punctuation section embedded shell begin raku"><span>/</span></span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>chomp</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>path</span></span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>~~</span></span><span>&nbsp;</span><span class="string regexp construct raku"><span>s</span></span><span class="punctuation definition regexp raku"><span>/</span></span><span class="string regexp raku"><span>\</span></span><span class="punctuation definition regexp raku"><span>/</span></span><span>[[\</span><span class="routine name raku"><span>w</span></span><span class="keyword operator generic raku"><span>+</span></span><span>]</span><span class="keyword operator generic raku"><span>+</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>%</span></span><span>&nbsp;\</span><span class="punctuation definition regexp raku"><span>/</span></span><span class="string regexp raku"><span>]</span></span><span class="punctuation definition regexp raku"><span>/</span></span><span>\0\</span><span class="keyword operator generic raku"><span>/</span></span><span class="routine name raku"><span>bar</span></span><span class="keyword operator generic raku"><span>/</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>path</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;and&nbsp;later</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>mysql_affected_rows</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="routine name raku"><span>LIBMYSQL</span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>bar</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="routine name raku"><span>LIBFOO</span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>baz</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="routine name raku"><span>LIBBAR</span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>You can also put an incomplete path like &#39;./foo&#39; and NativeCall will automatically put the right extension according to the platform specification. If you wish to suppress this expansion, simply pass the string as the body of a block.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>bar</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>./lib/Non&nbsp;Standard&nbsp;Naming&nbsp;Scheme</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>BE CAREFUL: the <code>native</code> trait and <code>constant</code> are evaluated at compile time. Don&#39;t write a constant that depends on a dynamic variable like:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;WRONG:</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>constant</span></span><span>&nbsp;</span><span class="routine name raku"><span>LIBMYSQL</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>%</span></span><span class="support class twigil raku"><span>*</span></span><span class="variable other identifier raku"><span>ENV</span></span></span><span class="span keyword operator array words raku"><span>&lt;</span></span><span class="string array words raku"><span>P6LIB_MYSQLCLIENT</span></span><span class="span keyword operator array words raku"><span>&gt;</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>||</span></span><span>&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>mysqlclient</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>;</span></span></div></pre><p>This will keep the value given at compile time. A module will be precompiled and <code>LIBMYSQL</code> will keep the value it acquires when the module gets precompiled.</p>
<h2 id="ABI/API_version"><a class="u" href="nativecall.html#___top" title="go to top of document">ABI/API version</a></h2>
<p>If you write <code>native(&#39;foo&#39;)</code> NativeCall will search <code>libfoo.so</code> under Unix like system (<code>libfoo.dynlib</code> on OS X, <code>foo.dll</code> on win32). In most modern system it will require you or the user of your module to install the development package because it&#39;s recommended to always provide an API/ABI version to a shared library, so <code>libfoo.so</code> ends often being a symbolic link provided only by a development package.</p>
<p>To avoid that, the <code>native</code> trait allows you to specify the API/ABI version. It can be a full version or just a part of it. (Try to stick to Major version, some BSD code does not care for Minor.)</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>foo1</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>,&nbsp;</span><span class="routine name raku"><span>v1</span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span><span>&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Will&nbsp;try&nbsp;to&nbsp;load&nbsp;libfoo.so.1</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>foo2</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>,&nbsp;</span><span class="routine name raku"><span>v1</span></span><span class="keyword operator generic raku"><span>.</span></span><span>2</span><span class="keyword operator generic raku"><span>.</span></span><span>3)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span><span>&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Will&nbsp;try&nbsp;to&nbsp;load&nbsp;libfoo.so.1.2.3</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>List</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>lib</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>foo</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>,&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>v1</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>);</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>foo3</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>lib</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><h2 id="Routine"><a class="u" href="nativecall.html#___top" title="go to top of document">Routine</a></h2>
<p>The <code>native</code> trait also accepts a <code>Callable</code> as argument, allowing you to provide your own way to handle the way it will find the library file to load.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>foo</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="routine name raku"><span>sub</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>libfoo.so.42</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span class="punctuation definition block raku"><span>}</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>It will only be called at the first invocation of the sub.</p>
<h2 id="Calling_into_the_standard_library"><a class="u" href="nativecall.html#___top" title="go to top of document">Calling into the standard library</a></h2>
<p>If you want to call a C function that&#39;s already loaded, either from the standard library or from your own program, you can omit the value, so <code>is native</code>.</p>
<p>For example on a UNIX-like operating system, you could use the following code to print the home directory of the current user:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>PwStruct</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>pw_name</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>pw_passwd</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>pw_uid</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>pw_gid</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>pw_gecos</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>pw_dir</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>pw_shell</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>getuid</span></span><span>()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>getpwuid</span></span><span>(</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>uid</span></span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="routine name raku"><span>PwStruct</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="routine name raku"><span>getpwuid</span></span><span>(</span><span class="routine name raku"><span>getuid</span></span><span>())</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>pw_dir</span></span><span>;</span></span></div></pre><p>Though of course <code>$*HOME</code> is a much easier way :-)!</p>
<h1 id="Exported_variables"><a class="u" href="nativecall.html#___top" title="go to top of document">Exported variables</a></h1>
<p>Variables exported by a library – also named &quot;global&quot; or &quot;extern&quot; variables – can be accessed using <code>cglobal</code>. For example:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>var</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>:=</span></span><span>&nbsp;</span><span class="routine name raku"><span>cglobal</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>libc.so.6</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>,&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>errno</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>,&nbsp;</span><span class="support type raku"><span>int32</span></span><span>)</span></span></div></pre><p>This code binds to <code>$var</code> a new <a href="../type/Proxy.html">Proxy</a> object that redirects all its accesses to the integer variable named &quot;errno&quot; as exported by the <code>libc.so.6</code> library.</p>
<h1 id="C++_support"><a class="u" href="nativecall.html#___top" title="go to top of document">C++ support</a></h1>
<p>NativeCall offers support to use classes and methods from C++ as shown in <a href="https://github.com/rakudo/rakudo/blob/master/t/04-nativecall/13-cpp-mangling.t">https://github.com/rakudo/rakudo/blob/master/t/04-nativecall/13-cpp-mangling.t</a> (and its associated C++ file). Note that at the moment it&#39;s not as tested and developed as C support.</p>
<h1 id="Helper_functions"><a class="u" href="nativecall.html#___top" title="go to top of document">Helper functions</a></h1>
<p>The <code>NativeCall</code> library exports several subroutines to help you work with data from native libraries.</p>
<h2 id="sub_nativecast"><a class="u" href="nativecall.html#___top" title="go to top of document">sub nativecast</a></h2>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>nativecast</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>target-type</span></span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>source</span></span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>export</span></span><span>(</span><span class="keyword operator generic raku"><span>:</span></span><span class="routine name raku"><span>DEFAULT</span></span><span>)</span></span></div></pre><p>This will <em>cast</em> the <code>Pointer</code> <code>$source</code> to an object of <code>$target-type</code>. The source pointer will typically have been obtained from a call to a native subroutine that returns a pointer or as a member of a <code>struct</code>, this may be specified as <code>void *</code> in the <code>C</code> library definition for instance, but you may also cast from a pointer to a less specific type to a more specific one.</p>
<p>As a special case, if a <a href="../type/Signature.html">Signature</a> is supplied as <code>$target-type</code> then a <code>subroutine</code> will be returned which will call the native function pointed to by <code>$source</code> in the same way as a subroutine declared with the <code>native</code> trait. This is described in <a href="https://rakudocs.github.io/language/nativecall#Function_pointers">Function Pointers</a>.</p>
<h2 id="sub_cglobal"><a class="u" href="nativecall.html#___top" title="go to top of document">sub cglobal</a></h2>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>cglobal</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>libname</span></span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>symbol</span></span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>target-type</span></span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>export</span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span></span></div></pre><p>This returns a <a href="../type/Proxy.html">Proxy</a> object that provides access to the <code>extern</code> named <code>$symbol</code> that is exposed by the specified library. The library can be specified in the same ways that they can be to the <code>native</code> trait.</p>
<h2 id="sub_nativesizeof"><a class="u" href="nativecall.html#___top" title="go to top of document">sub nativesizeof</a></h2>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>nativesizeof</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>obj</span></span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>export</span></span><span>(</span><span class="keyword operator generic raku"><span>:</span></span><span class="routine name raku"><span>DEFAULT</span></span><span>)</span></span></div></pre><p>This returns the size in bytes of the supplied object, it can be thought of as being equivalent to <code>sizeof</code> in <strong>C</strong>. The object can be a builtin native type such as <code>int64</code> or <code>num64</code>, a <code>CArray</code> or a class with the <code>repr</code> <code>CStruct</code>, <code>CUnion</code> or <code>CPointer</code>.</p>
<h2 id="sub_explicitly-manage"><a class="u" href="nativecall.html#___top" title="go to top of document">sub explicitly-manage</a></h2>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>explicitly-manage</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>str</span></span></span><span>)&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>export</span></span><span>(</span><span class="keyword operator generic raku"><span>:</span></span><span class="routine name raku"><span>DEFAULT</span></span><span>)</span></span></div></pre><p>This returns a <code>CStr</code> object for the given <code>Str</code>. If the string returned is passed to a NativeCall subroutine, it will not be freed by the runtime&#39;s garbage collector.</p>
<h1 id="Examples"><a class="u" href="nativecall.html#___top" title="go to top of document">Examples</a></h1>
<p>Some specific examples, and instructions to use examples above in particular platforms.</p>
<h2 id="PostgreSQL"><a class="u" href="nativecall.html#___top" title="go to top of document">PostgreSQL</a></h2>
<p>The PostgreSQL examples in <a href="https://github.com/raku-community-modules/DBIish/blob/master/examples/pg.p6">DBIish</a> make use of the NativeCall library and <code>is native</code> to use the native <code>_putenv</code> function call in Windows.</p>
<h2 id="MySQL"><a class="u" href="nativecall.html#___top" title="go to top of document">MySQL</a></h2>
<p><strong>NOTE:</strong> Please bear in mind that, under the hood, Debian has substituted MySQL with MariaDB since the Stretch version, so if you want to install MySQL, use <a href="https://dev.mysql.com/downloads/repo/apt/">MySQL APT repository</a> instead of the default repository.</p>
<p>To use the MySQL example in <a href="https://github.com/raku-community-modules/DBIish/blob/master/examples/mysql.p6">DBIish</a>, you&#39;ll need to install MySQL server locally; on Debian-esque systems it can be installed with something like:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="routine name raku"><span>wget</span></span><span>&nbsp;</span><span class="routine name raku"><span>https</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="keyword operator multi-symbol raku"><span>//</span></span><span class="routine name raku"><span>dev</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>mysql</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>com</span></span><span class="keyword operator generic raku"><span>/</span></span><span class="support function raku"><span>get</span></span><span class="keyword operator generic raku"><span>/</span></span><span class="routine name raku"><span>mysql-apt-config_0</span></span><span class="keyword operator generic raku"><span>.</span></span><span>8</span><span class="keyword operator generic raku"><span>.</span></span><span>10-1_all</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>deb</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>sudo</span></span><span>&nbsp;</span><span class="routine name raku"><span>dpkg</span></span><span>&nbsp;-</span><span class="routine name raku"><span>i</span></span><span>&nbsp;</span><span class="routine name raku"><span>mysql-apt-config_0</span></span><span class="keyword operator generic raku"><span>.</span></span><span>8</span><span class="keyword operator generic raku"><span>.</span></span><span>10-1_all</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>deb</span></span><span>&nbsp;</span><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>&nbsp;Don&#39;t&nbsp;forget&nbsp;to&nbsp;select&nbsp;5.6.x</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>sudo</span></span><span>&nbsp;</span><span class="routine name raku"><span>apt-get</span></span><span>&nbsp;</span><span class="routine name raku"><span>update</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>sudo</span></span><span>&nbsp;</span><span class="routine name raku"><span>apt-get</span></span><span>&nbsp;</span><span class="routine name raku"><span>install</span></span><span>&nbsp;</span><span class="routine name raku"><span>mysql-community-server</span></span><span>&nbsp;-</span><span class="routine name raku"><span>y</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>sudo</span></span><span>&nbsp;</span><span class="routine name raku"><span>apt-get</span></span><span>&nbsp;</span><span class="routine name raku"><span>install</span></span><span>&nbsp;</span><span class="routine name raku"><span>libmysqlclient18</span></span><span>&nbsp;-</span><span class="routine name raku"><span>y</span></span></span></div></pre><p>Prepare your system along these lines before trying out the examples:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other special-method raku"><span>$</span></span><span>&nbsp;</span><span class="routine name raku"><span>mysql</span></span><span>&nbsp;-</span><span class="routine name raku"><span>u</span></span><span>&nbsp;</span><span class="routine name raku"><span>root</span></span><span>&nbsp;-</span><span class="routine name raku"><span>p</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>SET</span></span><span>&nbsp;</span><span class="routine name raku"><span>PASSWORD</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>PASSWORD</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>sa</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>);</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>DROP</span></span><span>&nbsp;</span><span class="routine name raku"><span>DATABASE</span></span><span>&nbsp;</span><span class="routine name raku"><span>test</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>CREATE</span></span><span>&nbsp;</span><span class="routine name raku"><span>DATABASE</span></span><span>&nbsp;</span><span class="routine name raku"><span>test</span></span><span>;</span></span></div></pre><h2 id="Microsoft_Windows"><a class="u" href="nativecall.html#___top" title="go to top of document">Microsoft Windows</a></h2>
<p>Here is an example of a Windows API call:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>MessageBoxA</span></span><span>(</span><span class="support type raku"><span>int32</span></span><span>,&nbsp;</span><span class="support type raku"><span>Str</span></span><span>,&nbsp;</span><span class="support type raku"><span>Str</span></span><span>,&nbsp;</span><span class="support type raku"><span>int32</span></span><span>)</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>user32</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>MessageBoxA</span></span><span>(</span><span class="constant numeric raku"><span>0</span></span><span>,&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>We&nbsp;have&nbsp;NativeCall</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>,&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>ohai</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>,&nbsp;</span><span class="constant numeric raku"><span>64</span></span><span>);</span></span></div></pre><h2 id="Short_tutorial_on_calling_a_C_function"><a class="u" href="nativecall.html#___top" title="go to top of document">Short tutorial on calling a C function</a></h2>
<p>This is an example for calling a standard function and using the returned information in a Raku program.</p>
<p><code>getaddrinfo</code> is a POSIX standard function for obtaining network information about a network node, e.g., <code>google.com</code>. It is an interesting function to look at because it illustrates a number of the elements of NativeCall.</p>
<p>The Linux manual provides the following information about the C callable function:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="support type raku"><span>int</span></span><span>&nbsp;</span><span class="routine name raku"><span>getaddrinfo</span></span><span>(</span><span class="routine name raku"><span>const</span></span><span>&nbsp;</span><span class="routine name raku"><span>char</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="routine name raku"><span>node</span></span><span>,&nbsp;</span><span class="routine name raku"><span>const</span></span><span>&nbsp;</span><span class="routine name raku"><span>char</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="routine name raku"><span>service</span></span><span>,</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>const</span></span><span>&nbsp;</span><span class="routine name raku"><span>struct</span></span><span>&nbsp;</span><span class="routine name raku"><span>addrinfo</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="support function raku"><span>hints</span></span><span>,</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>struct</span></span><span>&nbsp;</span><span class="routine name raku"><span>addrinfo</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>**</span></span><span class="routine name raku"><span>res</span></span><span>);</span></span></div></pre><p>The function returns a response code 0 for success and 1 for error. The data are extracted from a linked list of <code>addrinfo</code> elements, with the first element pointed to by <code>res</code>.</p>
<p>From the table of NativeCall types we know that an <code>int</code> is <code>int32</code>. We also know that a <code>char *</code> is one of the forms C for a C <code>Str</code>, which maps simply to Str. But <code>addrinfo</code> is a structure, which means we will need to write our own type class. However, the function declaration is straightforward:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>getaddrinfo</span></span><span>(&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>node</span></span></span><span>,&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>service</span></span></span><span>,&nbsp;</span><span class="routine name raku"><span>Addrinfo</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>hints</span></span></span><span>,&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>res</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>&nbsp;)</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>returns</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>Note that <code>$res</code> is to be written by the function, so it must be labeled with the <code>is rw</code> trait. Since the library is standard POSIX, the library name can be the type definition or null.</p>
<p>We now have to handle structure <code>Addrinfo</code>. The Linux Manual provides this information:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="routine name raku"><span>struct</span></span><span>&nbsp;</span><span class="routine name raku"><span>addrinfo</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type raku"><span>int</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>ai_flags</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type raku"><span>int</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>ai_family</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type raku"><span>int</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>ai_socktype</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type raku"><span>int</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>ai_protocol</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>socklen_t</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>ai_addrlen</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>struct</span></span><span>&nbsp;</span><span class="routine name raku"><span>sockaddr</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="routine name raku"><span>ai_addr</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>char</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="routine name raku"><span>ai_canonname</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>struct</span></span><span>&nbsp;</span><span class="routine name raku"><span>addrinfo</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>*</span></span><span class="routine name raku"><span>ai_next</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span><span>;</span></span></div></pre><p>The <code>int, char*</code> parts are straightforward. Some research indicates that <code>socklen_t</code> can be architecture dependent, but is an unsigned integer of at least 32 bits. So <code>socklen_t</code> can be mapped to the <code>uint32</code> type.</p>
<p>The complication is <code>sockaddr</code> which differs depending on whether <code>ai_socktype</code> is undefined, INET, or INET6 (a standard v4 IP address or a v6 address).</p>
<p>So we create a Raku <code>class</code> to map to the C <code>struct addrinfo</code>; while we&#39;re at it, we also create another class for <code>SockAddr</code> which is needed for it.</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>SockAddr</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sa_family</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sa_data</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>Addrinfo</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_flags</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_family</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_socktype</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_protocol</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_addrlen</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="routine name raku"><span>SockAddr</span></span><span>&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_addr</span></span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_cannonname</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="routine name raku"><span>Addrinfo</span></span><span>&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_next</span></span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>The <code>is rw</code> on the last three attributes reflects that these were defined in C to be pointers.</p>
<p>The important thing here for mapping to a C <code>Struct</code> is the structure of the state part of the class, that is the attributes. However, a class can have methods and <code>NativeCall</code> does not &#39;touch&#39; them for mapping to C. This means that we can add extra methods to the class to unpack the attributes in a more readable manner, e.g.,</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>flags</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control flowcontrol raku"><span>do</span></span><span>&nbsp;</span><span class="keyword control repeat raku"><span>for</span></span><span>&nbsp;</span><span class="routine name raku"><span>AddrInfo-Flags</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>enums</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>key</span></span><span>&nbsp;</span><span class="keyword control conditional raku"><span>if</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>ai_flags</span></span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>+&amp;</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>value</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>By defining an appropriate <code>enum</code>, <code>flags</code> will return a string of keys rather than a bit packed integer.</p>
<p>The most useful information in the <code>sockaddr</code> structure is the address of node, which depends on the family of the Socket. So we can add method <code>address</code> to the Raku class that interprets the address depending on the family.</p>
<p>In order to get a human readable IP address, there is the C function <code>inet_ntop</code> which returns a <code>char *</code> given a buffer with the <code>addrinfo</code>.</p>
<p>Putting all these together, leads to the following program:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="comment line number-sign raku"><span class="punctuation definition comment raku"><span>#</span></span><span>!/usr/bin/env&nbsp;raku</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>v6</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="keyword other include raku"><span>use</span></span><span>&nbsp;</span><span class="constant language pragma raku"><span>NativeCall</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>constant</span></span><span>&nbsp;\</span><span class="routine name raku"><span>INET_ADDRSTRLEN</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>16</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span class="storage modifier declarator raku"><span>constant</span></span><span>&nbsp;\</span><span class="routine name raku"><span>INET6_ADDRSTRLEN</span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>46</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>enum</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>AddrInfo-Family</span></span></span><span>&nbsp;(</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AF_UNSPEC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>0</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AF_INET&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>2</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AF_INET6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>10</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>);</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>enum</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>AddrInfo-Socktype</span></span></span><span>&nbsp;(</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>SOCK_STREAM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>1</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>SOCK_DGRAM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>2</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>SOCK_RAW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>3</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>SOCK_RDM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>4</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>SOCK_SEQPACKET&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>5</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>SOCK_DCCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>6</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>SOCK_PACKET&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>10</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>);</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>enum</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>AddrInfo-Flags</span></span></span><span>&nbsp;(</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_PASSIVE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0001</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_CANONNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0002</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_NUMERICHOST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0004</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_V4MAPPED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0008</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_ALL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0010</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_ADDRCONFIG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0020</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_IDN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0040</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_CANONIDN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0080</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_IDN_ALLOW_UNASSIGNED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0100</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_IDN_USE_STD3_ASCII_RULES&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0200</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string pair key raku"><span>AI_NUMERICSERV&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="keyword operator multi-symbol raku"><span>=&gt;</span></span><span>&nbsp;</span><span class="constant numeric radix raku"><span>0x0400</span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>);</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>inet_ntop</span></span><span>(</span><span class="support type raku"><span>int32</span></span><span>,&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>,&nbsp;</span><span class="support type raku"><span>Blob</span></span><span>,&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>--&gt;</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>)</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>SockAddr</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint16</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sa_family</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>SockAddr-in</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int16</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sin_family</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint16</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sin_port</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sin_addr</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>address</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>buf</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>buf8</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>allocate</span></span><span>(</span><span class="routine name raku"><span>INET_ADDRSTRLEN</span></span><span>);</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>inet_ntop</span></span><span>(</span><span class="routine name raku"><span>AF_INET</span></span><span>,&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>(</span><span class="routine name raku"><span>nativecast</span></span><span>(</span><span class="support type raku"><span>Pointer</span></span><span>,</span><span class="variable language raku"><span>self</span></span><span>)</span><span class="keyword operator generic raku"><span>+</span></span><span>4),</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>buf</span></span></span><span>,&nbsp;</span><span class="routine name raku"><span>INET_ADDRSTRLEN</span></span><span>)</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>SockAddr-in6</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint16</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sin6_family</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint16</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sin6_port</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sin6_flowinfo</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint64</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sin6_addr0</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint64</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sin6_addr1</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>sin6_scope_id</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>address</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>buf</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="support type raku"><span>buf8</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>allocate</span></span><span>(</span><span class="routine name raku"><span>INET6_ADDRSTRLEN</span></span><span>);</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>inet_ntop</span></span><span>(</span><span class="routine name raku"><span>AF_INET6</span></span><span>,&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>new</span></span><span>(</span><span class="routine name raku"><span>nativecast</span></span><span>(</span><span class="support type raku"><span>Pointer</span></span><span>,</span><span class="variable language raku"><span>self</span></span><span>)</span><span class="keyword operator generic raku"><span>+</span></span><span>8),</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>buf</span></span></span><span>,&nbsp;</span><span class="routine name raku"><span>INET6_ADDRSTRLEN</span></span><span>)</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="meta class raku"><span class="storage type class raku"><span>class</span></span><span>&nbsp;</span><span class="entity name type class raku"><span>Addrinfo</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>repr</span></span><span>(</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>CStruct</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_flags</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_family</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_socktype</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_protocol</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>uint32</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_addrNativeCalllen</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="routine name raku"><span>SockAddr</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_addr</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_cannonname</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>has</span></span><span>&nbsp;</span><span class="routine name raku"><span>Addrinfo</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>ai_next</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>flags</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control flowcontrol raku"><span>do</span></span><span>&nbsp;</span><span class="keyword control repeat raku"><span>for</span></span><span>&nbsp;</span><span class="routine name raku"><span>AddrInfo-Flags</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>enums</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>key</span></span><span>&nbsp;</span><span class="keyword control conditional raku"><span>if</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>ai_flags</span></span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>+&amp;</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>.</span></span><span class="support function raku"><span>value</span></span><span>&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>family</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>AddrInfo-Family</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>ai_family</span></span></span><span>)</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>socktype</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>AddrInfo-Socktype</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>ai_socktype</span></span></span><span>)</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type declarator type raku"><span>method</span></span><span>&nbsp;</span><span class="entity name function raku"><span>address</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control repeat raku"><span>given</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>.</span></span><span class="variable other identifier raku"><span>family</span></span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control flowcontrol raku"><span>when</span></span><span>&nbsp;</span><span class="routine name raku"><span>AF_INET</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>nativecast</span></span><span>(</span><span class="routine name raku"><span>SockAddr-in</span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>ai_addr</span></span></span><span>)</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>address</span></span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control flowcontrol raku"><span>when</span></span><span>&nbsp;</span><span class="routine name raku"><span>AF_INET6</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>nativecast</span></span><span>(</span><span class="routine name raku"><span>SockAddr-in6</span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="support class twigil raku"><span>!</span></span><span class="variable other identifier raku"><span>ai_addr</span></span></span><span>)</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>address</span></span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>getaddrinfo</span></span><span>(</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>node</span></span></span><span>,&nbsp;</span><span class="support type raku"><span>Str</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>service</span></span></span><span>,&nbsp;</span><span class="routine name raku"><span>Addrinfo</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>hints</span></span></span><span>,</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>res</span></span></span><span>&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="entity name type trait raku"><span>rw</span></span><span>&nbsp;</span><span class="keyword operator multi-symbol raku"><span>--&gt;</span></span><span>&nbsp;</span><span class="support type raku"><span>int32</span></span><span>)</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span><span>}</span></span></span><span>;</span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>freeaddrinfo</span></span><span>(</span><span class="support type raku"><span>Pointer</span></span><span>)</span></span></div><div class="line"><span class="source raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier type constraints raku"><span>is</span></span><span>&nbsp;</span><span class="routine name raku"><span>native</span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span><span>}</span></span></span></span></div><div class="line"><span class="source raku"><span>&nbsp;</span></span></div><div class="line"><span class="source raku"><span class="storage type declarator type raku"><span>sub</span></span><span>&nbsp;</span><span class="entity name function raku"><span>MAIN</span></span><span>()&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="routine name raku"><span>Addrinfo</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>hint</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>.=</span></span><span>&nbsp;</span><span class="support function raku"><span>new</span></span><span>(</span><span class="keyword operator generic raku"><span>:</span></span><span class="routine name raku"><span>ai_flags</span></span><span>(</span><span class="routine name raku"><span>AI_CANONNAME</span></span><span>));</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="support type raku"><span>Pointer</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>res</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>.=</span></span><span>&nbsp;</span><span class="support function raku"><span>new</span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>rv</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>getaddrinfo</span></span><span>(</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>google.com</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>,&nbsp;</span><span class="support type raku"><span>Str</span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>hint</span></span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>res</span></span></span><span>);</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>return&nbsp;val:&nbsp;</span><span class="variable other identifier interpolated raku"><span class="variable other identifier sigil raku"><span>$</span></span><span>rv</span></span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>;</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control conditional raku"><span>if</span></span><span>&nbsp;(&nbsp;</span><span class="keyword operator generic raku"><span>!</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>rv</span></span></span><span>&nbsp;)&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier declarator raku"><span>my</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>addr</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="routine name raku"><span>nativecast</span></span><span>(</span><span class="routine name raku"><span>Addrinfo</span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>res</span></span></span><span>);</span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control repeat raku"><span>while</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>addr</span></span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control conditional raku"><span>with</span></span><span>&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>addr</span></span></span><span>&nbsp;</span><span class="meta block raku"><span class="punctuation definition block raku"><span>{</span></span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="string quoted double raku"><span class="punctuation definition string begin raku"><span>&quot;</span></span><span>Name:&nbsp;</span><span class="punctuation definition string end raku"><span>&quot;</span></span></span><span>,&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>_</span></span></span><span>&nbsp;</span><span class="keyword control conditional raku"><span>with</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>ai_cannonname</span></span><span>;</span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>family</span></span><span>,&nbsp;</span><span class="string quoted single single raku"><span class="punctuation definition string begin raku"><span>&#39;</span></span><span>&nbsp;</span><span class="punctuation definition string end raku"><span>&#39;</span></span></span><span>,&nbsp;</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>socktype</span></span><span>;</span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="support function raku"><span>say</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>address</span></span><span>;</span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>addr</span></span></span><span>&nbsp;</span><span class="storage modifier assignment raku"><span>=</span></span><span>&nbsp;</span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>ai_next</span></span><span>;</span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation definition block raku"><span>}</span></span></span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="routine name raku"><span>freeaddrinfo</span></span><span>(</span><span class="meta variable container raku"><span class="variable other identifier sigil raku"><span>$</span></span><span class="variable other identifier raku"><span>res</span></span></span><span>);</span></span></span></div><div class="line"><span class="source raku"><span class="meta block raku"><span class="punctuation definition block raku"><span>}</span></span></span></span></div></pre><p>This produces the following output:</p>
<pre class="editor editor-colors"><div class="line"><span class="source raku"><span class="keyword control flowcontrol raku"><span>return</span></span><span>&nbsp;</span><span class="routine name raku"><span>val</span></span><span class="keyword operator generic raku"><span>:</span></span><span>&nbsp;</span><span class="constant numeric raku"><span>0</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>Name</span></span><span class="keyword operator generic raku"><span>:</span></span><span>&nbsp;</span><span class="routine name raku"><span>google</span></span><span class="keyword operator generic raku"><span>.</span></span><span class="routine name raku"><span>com</span></span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>AF_INET</span></span><span>&nbsp;</span><span class="routine name raku"><span>SOCK_STREAM</span></span></span></div><div class="line"><span class="source raku"><span class="constant numeric raku"><span>216.58</span></span><span class="keyword operator generic raku"><span>.</span></span><span>219</span><span class="keyword operator generic raku"><span>.</span></span><span>206</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>AF_INET</span></span><span>&nbsp;</span><span class="routine name raku"><span>SOCK_DGRAM</span></span></span></div><div class="line"><span class="source raku"><span class="constant numeric raku"><span>216.58</span></span><span class="keyword operator generic raku"><span>.</span></span><span>219</span><span class="keyword operator generic raku"><span>.</span></span><span>206</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>AF_INET</span></span><span>&nbsp;</span><span class="routine name raku"><span>SOCK_RAW</span></span></span></div><div class="line"><span class="source raku"><span class="constant numeric raku"><span>216.58</span></span><span class="keyword operator generic raku"><span>.</span></span><span>219</span><span class="keyword operator generic raku"><span>.</span></span><span>206</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>AF_INET6</span></span><span>&nbsp;</span><span class="routine name raku"><span>SOCK_STREAM</span></span></span></div><div class="line"><span class="source raku"><span class="constant numeric raku"><span>2607</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="routine name raku"><span>f8b0</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="constant numeric raku"><span>4006</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="constant numeric raku"><span>800</span></span><span>::</span><span class="constant numeric raku"><span>200</span></span><span>e</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>AF_INET6</span></span><span>&nbsp;</span><span class="routine name raku"><span>SOCK_DGRAM</span></span></span></div><div class="line"><span class="source raku"><span class="constant numeric raku"><span>2607</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="routine name raku"><span>f8b0</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="constant numeric raku"><span>4006</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="constant numeric raku"><span>800</span></span><span>::</span><span class="constant numeric raku"><span>200</span></span><span>e</span></span></div><div class="line"><span class="source raku"><span class="routine name raku"><span>AF_INET6</span></span><span>&nbsp;</span><span class="routine name raku"><span>SOCK_RAW</span></span></span></div><div class="line"><span class="source raku"><span class="constant numeric raku"><span>2607</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="routine name raku"><span>f8b0</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="constant numeric raku"><span>4006</span></span><span class="keyword operator generic raku"><span>:</span></span><span class="constant numeric raku"><span>800</span></span><span>::</span><span class="constant numeric raku"><span>200</span></span><span>e</span></span></div></pre><h1 id="Platform_Specific_Notes"><a class="u" href="nativecall.html#___top" title="go to top of document">Platform Specific Notes</a></h1>
<h2 id="MacOS_-_DYLD_LIBRARY_PATH_is_ignored"><a class="u" href="nativecall.html#___top" title="go to top of document">MacOS - DYLD_LIBRARY_PATH is ignored</a></h2>
<p>On MacOSX El Capitan and later the <em>System Integrity Protection</em>, short SIP, prevents protected processes from passing through several environment variables, among them <code>DYLD_LIBRARY_PATH</code>. The <code>env</code> program, often used in <em>shebang</em> lines, is one of those programs. This means that whenever <code>env</code> is involved in calling a program the <code>DYLD_LIBRARY_PATH</code> variable will be cleared. To work around this effect one has to either make sure no protected process is involved (this can be difficult) or disable SIP.</p>
<p>This is usually not a problem when using popular installation methods such as <em>Homebrew</em> or <em>MacPorts</em>, tends to be more problematic when installing into non standard locations such as ones home directory and most definitely problematic when explicitly utilizing the <code>DYLD_LIBRARY_PATH</code> variable.</p>
<p>See <a href="https://developer.apple.com/library/archive/documentation/Security/Conceptual/System_Integrity_Protection_Guide/RuntimeProtections/RuntimeProtections.html">Apples documentation on SIP</a> for some more information. See <a href="https://briandfoy.github.io/macos-s-system-integrity-protection-sanitizes-your-environment/">brian d foy&#39;s blog post on the topic</a> for a more detailed explanation.</p>

        </div>
    </div>

    

    <footer class="pretty-box yellow">
        <p style="display:;">
            Generated from <a href="https://github.com/Raku/doc/edit/master/doc//Language/nativecall.pod6">https://github.com/Raku/doc/edit/master/doc//Language/nativecall.pod6</a>.
        </p>
        <p>
            This is a work in progress to document Raku (formerly known as Perl 6), and
            known to be incomplete.
        </p>
        <p>
            <a href="https://github.com/Raku/doc/blob/master/CONTRIBUTING.md#reporting-bugs">
                Please report any issues
            </a>
            Your contribution is appreciated.
        </p>
        <p>
            This documentation is provided under the terms of the
            <a href="https://raw.githubusercontent.com/Raku/doc/master/LICENSE">
                Artistic License 2.0
            </a>. The Camelia image is
            <a href="https://raw.githubusercontent.com/Raku/mu/master/misc/camelia.txt">
                copyright © 2009 by Larry Wall.
            </a>
            <!-- CREDITS -->
            <!--External Link Image by Zapyon, CCA-SA 4.0. Derived from Wikimedia Foundation https://commons.wikimedia.org/wiki/File:External-link-04-bold-12x12.svg -->
        </p>
    </footer>

    <script type="text/javascript" src="../js/app.js%3Fv=1"></script>
    <script type="text/javascript" src="../js/search.js%3Fv=3"></script>
</body>
</html>
